# 📊 TeleSubmit-v2 内存占用说明

## 快速回答

### 🎯 典型内存占用

| 场景 | 内存占用 | 推荐配置 |
|-----|---------|---------|
| **小型频道** (<1000 帖子) | ~150 MB | 256 MB |
| **中型频道** (1000-10000 帖子) | ~200-400 MB | 512 MB |
| **大型频道** (10000-50000 帖子) | ~400-700 MB | 1 GB |
| **超大频道** (>50000 帖子) | ~700+ MB | 1-2 GB |

### 🚀 最小要求
- **内存**: 256 MB（包含搜索功能）
- **磁盘**: 100 MB（代码 + 依赖 + 小型数据库）

---

## 详细分析

### 1️⃣ 基础内存占用

```
┌─────────────────────────────────────────┐
│ 组件                    │ 内存占用      │
├─────────────────────────────────────────┤
│ Python 解释器           │ ~16 MB        │
│ python-telegram-bot     │ ~29 MB        │
│ Whoosh 搜索引擎          │ ~0.5 MB       │
│ jieba 中文分词           │ ~22 MB        │
│ aiosqlite 异步数据库     │ ~0.5 MB       │
│ 其他依赖                │ ~2 MB         │
├─────────────────────────────────────────┤
│ 小计（静态加载）         │ ~70 MB        │
└─────────────────────────────────────────┘
```

### 2️⃣ 运行时内存占用

```
┌─────────────────────────────────────────┐
│ 组件                    │ 内存占用      │
├─────────────────────────────────────────┤
│ Bot 框架和连接           │ ~50 MB        │
│ 对话状态管理             │ ~10 MB        │
│ 消息缓存                │ ~20 MB        │
├─────────────────────────────────────────┤
│ 小计（运行时开销）       │ ~80 MB        │
└─────────────────────────────────────────┘
```

### 3️⃣ 搜索索引内存占用

搜索索引的内存占用取决于帖子数量和内容大小：

```python
# 估算公式
索引内存 ≈ 索引文件大小 × 25%

# 典型数据
- 100 帖子   → 索引 ~500 KB   → 内存 ~0.1 MB
- 1000 帖子  → 索引 ~5 MB     → 内存 ~1.2 MB
- 10000 帖子 → 索引 ~50 MB    → 内存 ~12 MB
- 50000 帖子 → 索引 ~250 MB   → 内存 ~60 MB
```

> 💡 **注意**: Whoosh 采用磁盘存储 + 按需加载的策略，不会将整个索引加载到内存

### 4️⃣ 数据库内存占用

SQLite 数据库采用按需加载：

```python
- 1000 帖子   → 数据库 ~1 MB    → 内存 ~2 MB
- 10000 帖子  → 数据库 ~10 MB   → 内存 ~20 MB
- 50000 帖子  → 数据库 ~50 MB   → 内存 ~100 MB
```

---

## 📈 内存占用计算

### 完整公式

```python
总内存 = 基础内存 + 运行时内存 + 索引内存 + 数据库内存

基础内存 = 70 MB（固定）
运行时内存 = 80 MB（固定）
索引内存 = 索引文件大小 × 0.25
数据库内存 = 数据库文件大小 × 2
```

### 示例计算

#### 场景 1: 小型频道 (500 帖子)

```
基础内存:   70 MB
运行时:     80 MB
索引内存:   2.5 MB (10 MB 索引 × 0.25)
数据库:     1 MB (0.5 MB DB × 2)
─────────────────
总计:      ~153 MB

推荐配置:   256 MB
```

#### 场景 2: 中型频道 (5000 帖子)

```
基础内存:   70 MB
运行时:     80 MB
索引内存:   7.5 MB (30 MB 索引 × 0.25)
数据库:     10 MB (5 MB DB × 2)
─────────────────
总计:      ~167 MB

推荐配置:   256-512 MB
```

#### 场景 3: 大型频道 (20000 帖子)

```
基础内存:   70 MB
运行时:     80 MB
索引内存:   25 MB (100 MB 索引 × 0.25)
数据库:     40 MB (20 MB DB × 2)
─────────────────
总计:      ~215 MB

推荐配置:   512 MB
```

#### 场景 4: 超大频道 (100000 帖子)

```
基础内存:   70 MB
运行时:     80 MB
索引内存:   125 MB (500 MB 索引 × 0.25)
数据库:     200 MB (100 MB DB × 2)
─────────────────
总计:      ~475 MB

推荐配置:   1 GB
```

---

## 🔧 内存优化建议

### 1. 禁用搜索功能（节省 ~30-100 MB）

如果不需要搜索功能，可以在 `config.ini` 中禁用：

```ini
[SEARCH]
ENABLED = false
```

**节省内存**:
- Whoosh 库: ~0.5 MB
- jieba 分词: ~22 MB
- 索引内存: 根据帖子数量
- **总计**: ~30-100 MB（根据帖子数量）

### 2. 调整统计更新频率（降低 CPU 和内存峰值）

在 `main.py` 中：

```python
# 默认每小时更新
job_queue.run_repeating(update_post_stats, interval=3600, first=60)

# 改为每 2 小时更新
job_queue.run_repeating(update_post_stats, interval=7200, first=60)
```

### 3. 定期清理日志文件

日志文件会持续增长：

```bash
# 手动清理
rm -rf logs/*.log

# 或使用 logrotate 自动清理
```

### 4. 优化搜索索引（减少索引大小）

```bash
# 运行索引优化
python3 -c "
from utils.index_manager import IndexManager
manager = IndexManager()
manager.optimize_index()
"
```

---

## 🐳 Docker 部署配置

### 默认配置（适用于大多数场景）

```yaml
# docker-compose.yml
deploy:
  resources:
    limits:
      cpus: '2.0'
      memory: 1G          # 内存上限
    reservations:
      cpus: '0.5'
      memory: 256M        # 预留内存
```

### 小型频道（<1000 帖子）

```yaml
deploy:
  resources:
    limits:
      memory: 256M
    reservations:
      memory: 128M
```

### 中型频道（1000-10000 帖子）

```yaml
deploy:
  resources:
    limits:
      memory: 512M
    reservations:
      memory: 256M
```

### 大型频道（10000-50000 帖子）

```yaml
deploy:
  resources:
    limits:
      memory: 1G
    reservations:
      memory: 512M
```

### 超大频道（>50000 帖子）

```yaml
deploy:
  resources:
    limits:
      memory: 2G
    reservations:
      memory: 1G
```

---

## 📊 实际测试数据

### 测试环境
- **操作系统**: Linux (Ubuntu 22.04)
- **Python 版本**: 3.11
- **Docker**: 24.0.7

### 测试结果

| 帖子数 | 数据库大小 | 索引大小 | 内存占用 | 启动时间 |
|-------|-----------|---------|---------|---------|
| 100   | 60 KB     | 500 KB  | 155 MB  | 3 秒    |
| 1000  | 1.2 MB    | 5 MB    | 168 MB  | 4 秒    |
| 5000  | 8 MB      | 30 MB   | 195 MB  | 6 秒    |
| 10000 | 18 MB     | 70 MB   | 230 MB  | 8 秒    |
| 50000 | 120 MB    | 400 MB  | 450 MB  | 15 秒   |

---

## 🛠️ 内存分析工具

项目提供了内存分析工具，可以查看当前环境的实际内存占用：

```bash
# 运行内存分析
python3 analyze_memory.py
```

**输出示例**:
```
======================================================================
📊 TeleSubmit-v2 内存占用分析
======================================================================

1️⃣  Python 解释器基础内存: 16.47 MB

2️⃣  主要依赖库内存占用:
----------------------------------------------------------------------
  • python-telegram-bot           : + 28.84 MB
  • Whoosh 搜索引擎                   : +  0.00 MB
  • jieba 分词                      : + 21.52 MB
  • aiosqlite 数据库                 : +  0.48 MB
  依赖库总计                         : + 50.84 MB

...

📈 总内存占用估算
======================================================================
  • 估算总计: ~147.32 MB

💡 部署建议
======================================================================
  状态: ✅ 轻量级
  最小内存要求: 256 MB
  推荐配置: 220 MB (预留50%缓冲)
```

---

## 🎓 常见问题

### Q1: 为什么实际内存占用比估算高？

**可能原因**:
1. **Python 内存分配策略**: Python 不会立即释放内存
2. **峰值内存**: 统计更新时会临时占用更多内存
3. **系统缓存**: 操作系统会缓存文件数据

**建议**: 预留 50% 缓冲空间

### Q2: 如何监控实际内存占用？

**方法 1: 使用 Docker 命令**

```bash
docker stats telesubmit-v2
```

**方法 2: 使用 Bot 命令**

```
/debug  # 查看实时内存占用（仅 OWNER 可用）
```

**方法 3: 使用 psutil**

```python
import psutil
process = psutil.Process()
print(f"内存: {process.memory_info().rss / 1024 / 1024:.2f} MB")
```

### Q3: 内存不足怎么办？

**短期方案**:
1. 禁用搜索功能（节省 ~30-100 MB）
2. 减少统计更新频率
3. 清理旧日志文件

**长期方案**:
1. 升级服务器内存
2. 使用独立的搜索服务（如 Elasticsearch）
3. 定期归档旧帖子

### Q4: 为什么 jieba 占用这么多内存？

**原因**: jieba 需要加载中文词典（约 20 MB）

**解决方案**:
1. 如果不需要搜索功能，禁用 `SEARCH_ENABLED`
2. jieba 只在搜索时使用，内存占用是一次性的

---

## 📚 相关文档

- [Docker 部署指南](DEPLOYMENT.md)
- [配置说明](config.ini.example)
- [搜索引擎说明](README.md#搜索功能)
- [索引管理器](utils/index_manager.py)

---

## 🔗 外部资源

- [Whoosh 性能优化](https://whoosh.readthedocs.io/en/latest/indexing.html#performance)
- [SQLite 内存管理](https://www.sqlite.org/memory.html)
- [Python 内存分析](https://docs.python.org/3/library/tracemalloc.html)

---

**最后更新**: 2025-10-25  
**维护者**: TeleSubmit-v2 团队

