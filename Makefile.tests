# æµ‹è¯•ç›¸å…³çš„ Makefile å‘½ä»¤

.PHONY: test test-unit test-integration test-cov test-html test-fast test-slow clean-test

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
test:
	@echo "ğŸ§ª è¿è¡Œæ‰€æœ‰æµ‹è¯•..."
	pytest

# åªè¿è¡Œå•å…ƒæµ‹è¯•
test-unit:
	@echo "ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•..."
	pytest -m unit

# åªè¿è¡Œé›†æˆæµ‹è¯•
test-integration:
	@echo "ğŸ§ª è¿è¡Œé›†æˆæµ‹è¯•..."
	pytest -m integration

# è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
test-cov:
	@echo "ğŸ“Š è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š..."
	pytest --cov=. --cov-report=term-missing

# ç”Ÿæˆ HTML è¦†ç›–ç‡æŠ¥å‘Š
test-html:
	@echo "ğŸ“Š ç”Ÿæˆ HTML è¦†ç›–ç‡æŠ¥å‘Š..."
	pytest --cov=. --cov-report=html
	@echo "âœ… æŠ¥å‘Šå·²ç”Ÿæˆåˆ° htmlcov/index.html"

# å¿«é€Ÿæµ‹è¯•ï¼ˆè·³è¿‡æ…¢é€Ÿæµ‹è¯•ï¼‰
test-fast:
	@echo "âš¡ è¿è¡Œå¿«é€Ÿæµ‹è¯•..."
	pytest -m "not slow"

# è¿è¡Œæ…¢é€Ÿæµ‹è¯•
test-slow:
	@echo "ğŸŒ è¿è¡Œæ…¢é€Ÿæµ‹è¯•..."
	pytest -m slow

# è¿è¡Œæ•°æ®åº“æµ‹è¯•
test-db:
	@echo "ğŸ—„ï¸  è¿è¡Œæ•°æ®åº“æµ‹è¯•..."
	pytest -m database

# æµ‹è¯•ç‰¹å®šæ–‡ä»¶
test-file:
	@echo "ğŸ“„ æµ‹è¯•æŒ‡å®šæ–‡ä»¶..."
	@if [ -z "$(FILE)" ]; then \
		echo "âŒ è¯·æŒ‡å®šæ–‡ä»¶: make test-file FILE=tests/test_xxx.py"; \
		exit 1; \
	fi
	pytest $(FILE)

# è¯¦ç»†è¾“å‡ºæ¨¡å¼
test-verbose:
	@echo "ğŸ“¢ è¯¦ç»†è¾“å‡ºæ¨¡å¼..."
	pytest -v

# å¹¶è¡Œè¿è¡Œæµ‹è¯•ï¼ˆéœ€è¦ pytest-xdistï¼‰
test-parallel:
	@echo "âš¡ å¹¶è¡Œè¿è¡Œæµ‹è¯•..."
	pytest -n auto

# è¿è¡Œå¹¶è¿›å…¥è°ƒè¯•æ¨¡å¼
test-debug:
	@echo "ğŸ› è°ƒè¯•æ¨¡å¼..."
	pytest --pdb

# æ˜¾ç¤ºæœ€æ…¢çš„ 10 ä¸ªæµ‹è¯•
test-profile:
	@echo "â±ï¸  åˆ†ææµ‹è¯•æ€§èƒ½..."
	pytest --durations=10

# åªè¿è¡Œä¸Šæ¬¡å¤±è´¥çš„æµ‹è¯•
test-failed:
	@echo "ğŸ”„ è¿è¡Œä¸Šæ¬¡å¤±è´¥çš„æµ‹è¯•..."
	pytest --lf

# æ¸…ç†æµ‹è¯•ç¼“å­˜å’ŒæŠ¥å‘Š
clean-test:
	@echo "ğŸ§¹ æ¸…ç†æµ‹è¯•æ–‡ä»¶..."
	rm -rf .pytest_cache
	rm -rf htmlcov
	rm -rf .coverage
	rm -rf *.pyc
	rm -rf __pycache__
	find . -type d -name "__pycache__" -exec rm -rf {} +
	find . -type f -name "*.pyc" -delete
	@echo "âœ… æ¸…ç†å®Œæˆ"

# å®‰è£…æµ‹è¯•ä¾èµ–
install-test:
	@echo "ğŸ“¦ å®‰è£…æµ‹è¯•ä¾èµ–..."
	pip install pytest pytest-asyncio pytest-cov pytest-mock coverage

# æ£€æŸ¥æµ‹è¯•è¦†ç›–ç‡å¹¶ç”ŸæˆæŠ¥å‘Š
coverage-report:
	@echo "ğŸ“Š ç”Ÿæˆå®Œæ•´è¦†ç›–ç‡æŠ¥å‘Š..."
	pytest --cov=. --cov-report=html --cov-report=term-missing --cov-report=xml
	@echo "âœ… HTML æŠ¥å‘Š: htmlcov/index.html"
	@echo "âœ… XML æŠ¥å‘Š: coverage.xml"

# ç›‘æ§æ–‡ä»¶å˜åŒ–è‡ªåŠ¨è¿è¡Œæµ‹è¯•ï¼ˆéœ€è¦ pytest-watchï¼‰
watch:
	@echo "ğŸ‘€ ç›‘æ§æ–‡ä»¶å˜åŒ–..."
	@command -v ptw >/dev/null 2>&1 || { \
		echo "âŒ pytest-watch æœªå®‰è£…"; \
		echo "ğŸ“¦ å®‰è£…: pip install pytest-watch"; \
		exit 1; \
	}
	ptw

# ç”Ÿæˆæµ‹è¯•æŠ¥å‘Šï¼ˆJUnit XMLï¼‰
test-report:
	@echo "ğŸ“„ ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š..."
	pytest --junitxml=report.xml
	@echo "âœ… æŠ¥å‘Šå·²ç”Ÿæˆåˆ° report.xml"

# è¿è¡Œæµ‹è¯•å¹¶åœ¨æµè§ˆå™¨æ‰“å¼€è¦†ç›–ç‡æŠ¥å‘Š
test-open:
	@echo "ğŸ§ª è¿è¡Œæµ‹è¯•å¹¶æ‰“å¼€æŠ¥å‘Š..."
	pytest --cov=. --cov-report=html
	@if [ "$(shell uname)" = "Darwin" ]; then \
		open htmlcov/index.html; \
	elif [ "$(shell uname)" = "Linux" ]; then \
		xdg-open htmlcov/index.html; \
	else \
		echo "âœ… æŠ¥å‘Šå·²ç”Ÿæˆåˆ° htmlcov/index.html"; \
	fi

# å¸®åŠ©ä¿¡æ¯
help-test:
	@echo "ğŸ“š æµ‹è¯•å‘½ä»¤å¸®åŠ©ï¼š"
	@echo ""
	@echo "  make test              - è¿è¡Œæ‰€æœ‰æµ‹è¯•"
	@echo "  make test-unit         - åªè¿è¡Œå•å…ƒæµ‹è¯•"
	@echo "  make test-integration  - åªè¿è¡Œé›†æˆæµ‹è¯•"
	@echo "  make test-cov          - è¿è¡Œæµ‹è¯•å¹¶æ˜¾ç¤ºè¦†ç›–ç‡"
	@echo "  make test-html         - ç”Ÿæˆ HTML è¦†ç›–ç‡æŠ¥å‘Š"
	@echo "  make test-fast         - å¿«é€Ÿæµ‹è¯•ï¼ˆè·³è¿‡æ…¢é€Ÿæµ‹è¯•ï¼‰"
	@echo "  make test-slow         - è¿è¡Œæ…¢é€Ÿæµ‹è¯•"
	@echo "  make test-db           - è¿è¡Œæ•°æ®åº“æµ‹è¯•"
	@echo "  make test-file FILE=<path> - æµ‹è¯•æŒ‡å®šæ–‡ä»¶"
	@echo "  make test-verbose      - è¯¦ç»†è¾“å‡ºæ¨¡å¼"
	@echo "  make test-parallel     - å¹¶è¡Œè¿è¡Œæµ‹è¯•"
	@echo "  make test-debug        - è°ƒè¯•æ¨¡å¼"
	@echo "  make test-profile      - æ˜¾ç¤ºæœ€æ…¢çš„æµ‹è¯•"
	@echo "  make test-failed       - åªè¿è¡Œä¸Šæ¬¡å¤±è´¥çš„æµ‹è¯•"
	@echo "  make test-open         - è¿è¡Œæµ‹è¯•å¹¶æ‰“å¼€è¦†ç›–ç‡æŠ¥å‘Š"
	@echo "  make clean-test        - æ¸…ç†æµ‹è¯•æ–‡ä»¶"
	@echo "  make install-test      - å®‰è£…æµ‹è¯•ä¾èµ–"
	@echo "  make coverage-report   - ç”Ÿæˆå®Œæ•´è¦†ç›–ç‡æŠ¥å‘Š"
	@echo "  make watch             - ç›‘æ§æ–‡ä»¶å˜åŒ–è‡ªåŠ¨è¿è¡Œæµ‹è¯•"
	@echo "  make test-report       - ç”Ÿæˆ JUnit XML æŠ¥å‘Š"
	@echo ""
