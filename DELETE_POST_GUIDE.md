# 帖子删除功能指南

本文档详细说明 TeleSubmit-v2 机器人的帖子删除功能。

## 功能概述

帖子删除功能仅限 **OWNER（管理员）** 使用，用于管理已发布的投稿。删除操作会：
- ✅ 从数据库中删除帖子记录
- ✅ 从搜索索引中删除
- ❌ **不会**删除频道中的实际消息（需手动删除）

> **设计理念**：数据库删除是"软删除"，只移除索引，不影响频道内容。这样更安全，管理员可以自行决定是否在频道中删除消息。

---

## 权限说明

### 谁可以删除帖子？

只有在 `config.ini` 中配置的 `OWNER_ID` 用户才能删除帖子。普通用户**无法删除任何帖子**，即使是自己发布的。

```ini
[telegram]
OWNER_ID = 123456789  # 替换为您的 Telegram 用户 ID
```

### 权限检查机制

- 所有删除操作都会进行权限检查
- 非 OWNER 用户尝试删除会收到"权限不足"提示
- 操作会记录在日志中，便于追踪

---

## 删除方式

### 方式一：搜索结果中删除（推荐）

使用 `/search` 命令搜索帖子后，OWNER 会在每个搜索结果下方看到 **🗑️ 删除** 按钮。

**步骤：**

1. 使用 `/search 关键词` 搜索帖子
2. 在搜索结果中找到要删除的帖子
3. 点击 **🗑️ 删除** 按钮
4. 确认删除操作

**示例：**

```
/search 测试
```

搜索结果会显示：
```
🔍 搜索结果：找到 3 个结果

📄 测试帖子标题
#测试 #示例
📅 2024-01-20 | 👀 100 浏览 | 🔥 50.5 热度
🔗 https://t.me/your_channel/123

[👁️ 查看原帖] [🗑️ 删除]  <- OWNER 可见
```

---

### 方式二：我的投稿中删除

使用 `/myposts` 命令查看自己的投稿（OWNER 专用），每个帖子下方会显示删除按钮。

**步骤：**

1. 使用 `/myposts` 查看投稿列表
2. 找到要删除的帖子
3. 点击 **🗑️ 删除** 按钮
4. 确认删除操作

**示例：**

```
/myposts
```

返回结果：
```
📝 我的投稿（最近 5 篇）

💡 提示：作为管理员，您可以直接删除帖子

📄 1. 测试帖子
#测试
📅 2024-01-20 10:30
📊 浏览 100 | 转发 5 | 热度 50
🔗 https://t.me/your_channel/123

[👁️ 查看原帖]
[🗑️ 删除]  <- OWNER 可见
```

---

### 方式三：批量删除

使用 `/delete_posts` 命令批量删除多个帖子。支持单个 ID 和 ID 范围。

#### 命令格式

```bash
# 删除单个帖子
/delete_posts [message_id]

# 删除多个帖子（空格分隔）
/delete_posts [message_id1] [message_id2] [message_id3]

# 删除连续范围（使用短横线）
/delete_posts [start_id-end_id]

# 混合使用（范围 + 单个 ID）
/delete_posts [start_id-end_id] [single_id] [another_range]
```

#### 使用示例

**示例 1：删除单个帖子**
```bash
/delete_posts 123
```

**示例 2：删除多个独立帖子**
```bash
/delete_posts 123 456 789
```
- 删除消息 ID 为 123、456、789 的帖子

**示例 3：删除连续范围**
```bash
/delete_posts 100-110
```
- 删除消息 ID 从 100 到 110 的所有帖子（共 11 个）

**示例 4：混合使用**
```bash
/delete_posts 100-110 150 200-205
```
- 删除 100-110（11 个）
- 删除 150（1 个）
- 删除 200-205（6 个）
- 共删除 18 个帖子

#### 批量删除限制

- **最多删除 50 个帖子**：一次操作不能超过 50 个，防止误操作
- **自动跳过不存在的帖子**：如果某些 ID 不存在，会自动跳过并在结果中报告
- **详细统计报告**：删除完成后会显示成功/失败/未找到的统计

#### 批量删除返回示例

```
✅ 批量删除完成

📊 统计：
• 成功删除：15 个
• 从索引删除：15 个
• 未找到：2 个
• 失败：0 个

⚠️ 注意：
频道中的消息未被删除，如需删除请在频道中手动操作。
```

---

## 删除确认流程

为了防止误删，所有删除操作都需要二次确认。

### 确认对话框

点击删除按钮后，会弹出确认对话框：

```
⚠️ 删除确认

确定要删除消息 ID 为 123 的帖子记录吗？

⚠️ 此操作将：
• ✅ 从数据库删除记录
• ✅ 从搜索索引删除
• ❌ 不会删除频道消息（需手动删除）

此操作不可恢复！

[✅ 确认] [❌ 取消]
```

### 确认操作

- 点击 **✅ 确认**：执行删除操作
- 点击 **❌ 取消**：取消删除，不做任何改动

---

## 删除结果

### 成功删除

删除成功后会显示详细的操作结果：

```
✅ 删除操作完成

📝 消息ID: 123
🔗 频道链接: https://t.me/your_channel/123

已完成：
✅ 从数据库删除记录
✅ 从搜索索引删除（包含 2 个关联消息）

⚠️ 注意：
频道中的消息未被删除，如需删除请手动操作。
可以直接访问上方链接或在频道中查找消息 ID 123 进行删除。
```

### 删除失败

如果删除失败，会显示错误信息：

```
❌ 帖子不存在或已被删除
```

或

```
❌ 删除失败: [错误详情]
```

---

## 手动删除频道消息

删除数据库记录后，频道中的消息仍然存在。如需删除频道消息，请按以下步骤操作：

### 方法一：通过链接直接删除

1. 在删除结果中点击提供的频道链接
2. 在 Telegram 中打开该消息
3. 长按消息（移动端）或右键点击（桌面端）
4. 选择"删除消息"
5. 确认删除

### 方法二：通过消息 ID 查找删除

1. 打开频道
2. 在频道中搜索消息 ID（例如：`#123`）
3. 找到对应消息
4. 删除该消息

### 批量删除频道消息

如果需要批量删除频道消息，可以使用 Telegram 的管理员功能：

1. 进入频道管理界面
2. 选择"查看消息记录"
3. 筛选时间范围或搜索特定内容
4. 选中多个消息
5. 批量删除

---

## 删除的帖子包括什么？

删除操作会移除：

1. **主帖子记录**
   - 数据库中的 `published_posts` 表记录
   - 搜索索引中的主帖子

2. **关联消息**（如果有）
   - 多媒体投稿可能包含多条频道消息
   - 这些关联消息也会从搜索索引中移除
   - 数据库中的 `related_message_ids` 字段记录了这些关联消息

3. **统计数据**
   - 浏览量、转发量、热度等统计数据
   - 这些数据随记录一起删除

---

## 常见问题 FAQ

### Q1: 为什么不直接删除频道消息？

**A:** 这是一个安全设计决策。原因如下：
- 防止误操作导致重要内容丢失
- 给管理员留出审查时间
- 可以先从搜索中隐藏，再决定是否删除实际内容
- 数据库操作可以回滚，但频道消息删除是永久的

### Q2: 删除后用户还能看到帖子吗？

**A:** 删除数据库记录后：
- ❌ 搜索功能中不会再显示该帖子
- ❌ 统计数据中不再包含该帖子
- ❌ "我的投稿"列表中不再显示
- ✅ 频道中的消息仍然可见（直到手动删除）

### Q3: 删除操作可以撤销吗？

**A:** 不可以。数据库删除操作是永久的，无法撤销。因此删除前会有二次确认。

### Q4: 批量删除时出现"未找到"是什么意思？

**A:** "未找到"表示该消息 ID 在数据库中不存在，可能原因：
- 消息 ID 输入错误
- 该帖子已经被删除
- 该消息不是通过机器人发布的

这不是错误，批量删除会自动跳过这些 ID。

### Q5: 为什么我看不到删除按钮？

**A:** 删除按钮只对 OWNER 可见。检查：
1. 您的 Telegram 用户 ID 是否与 `config.ini` 中的 `OWNER_ID` 一致
2. 重启机器人以加载新配置
3. 查看日志文件确认权限检查结果

### Q6: 如何获取我的 Telegram 用户 ID？

**A:** 使用以下方法之一：
- 向 @userinfobot 发送消息
- 使用 `/debug` 命令（如果机器人支持）
- 在日志文件中查看您发送消息时的用户 ID

### Q7: 删除操作会影响其他用户的投稿吗？

**A:** 不会。删除操作只针对指定的消息 ID，不会影响其他帖子。每个帖子的消息 ID 都是唯一的。

### Q8: 删除后搜索索引会立即更新吗？

**A:** 是的。删除操作会立即从搜索索引中移除该帖子，用户马上就搜索不到被删除的内容。

---

## 技术实现细节

### 数据库操作

```sql
-- 删除帖子记录
DELETE FROM published_posts WHERE message_id = ?;
```

### 搜索索引操作

```python
# 从搜索引擎删除
search_engine.delete_post(message_id)

# 删除关联消息
for related_id in related_message_ids:
    search_engine.delete_post(related_id)
```

### 日志记录

所有删除操作都会记录在日志中：
```
INFO: 批量删除：已删除帖子 message_id=123
INFO: 已从搜索索引删除帖子: 123
INFO: 已从数据库删除帖子记录: ID=45, message_id=123
```

---

## 安全建议

1. **定期备份数据库**
   - 删除操作不可逆，建议定期备份 `data/bot.db`
   - 使用 `sqlite3` 工具导出数据

2. **谨慎使用批量删除**
   - 批量删除前先确认 ID 范围
   - 建议先用小范围测试
   - 检查 `/search` 结果确认要删除的帖子

3. **保护 OWNER_ID**
   - 不要将 `config.ini` 文件提交到公共仓库
   - 定期更换访问令牌
   - 监控日志中的权限检查记录

4. **手动验证**
   - 删除前访问频道链接确认内容
   - 重要帖子建议先截图保存
   - 删除后检查频道确认结果

---

## 命令速查表

| 命令 | 用途 | 权限 | 示例 |
|------|------|------|------|
| `/search` | 搜索帖子并显示删除按钮 | OWNER | `/search 测试` |
| `/myposts` | 查看投稿列表（OWNER 可删除） | All (OWNER 可删除) | `/myposts` |
| `/delete_posts` | 批量删除帖子 | OWNER | `/delete_posts 100-110` |

---

## 更新日志

### v2.0.0 (2024-01-20)
- ✨ 新增搜索结果中的删除按钮
- ✨ 新增 /myposts 中的删除按钮（OWNER 专用）
- ✨ 新增批量删除命令 /delete_posts
- 🔒 强化权限检查，确保只有 OWNER 可以删除
- 📝 优化删除确认流程
- 🔍 改进删除操作只删除数据库和索引，不删除频道消息
- 📊 添加详细的删除统计报告

---

## 相关文档

- [README.md](README.md) - 项目总览
- [CHANGELOG.md](CHANGELOG.md) - 完整更新日志
- [config.ini.example](config.ini.example) - 配置文件示例

---

## 技术支持

如遇到问题，请：
1. 查看日志文件 `logs/bot.log`
2. 检查配置文件 `config.ini`
3. 参考本文档的常见问题部分
4. 提交 Issue 到项目仓库

---

**最后更新**: 2024-01-20  
**版本**: v2.0.0
