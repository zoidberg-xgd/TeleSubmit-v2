# 统计功能常见问题

## 🤔 为什么浏览量和热度显示为 0？

### 正常情况

如果帖子刚发布不久（几分钟到几小时），浏览量为 0 是**完全正常**的：

1. **Telegram 统计延迟**
   - Telegram 的浏览量统计不是实时的
   - 需要一定时间才会更新（通常几分钟到几小时）
   - 低流量频道的统计更新更慢

2. **Bot 更新频率**
   - Bot 每小时自动更新一次统计
   - 如果想立即查看，可以手动触发更新

3. **频道流量**
   - 如果频道订阅者较少或不活跃
   - 浏览量自然会很低甚至为 0

### 如何手动更新统计

#### 方法 1：通过热门命令

```
1. 发送 /hot 给 Bot
2. 点击 "🔄 刷新" 按钮
```

#### 方法 2：通过管理面板

```
1. 发送 "👑 管理面板"（或 /start 选择管理面板）
2. 点击 "🔄 更新统计"
```

#### 方法 3：命令行诊断

```bash
python3 diagnose_stats.py
```

这会显示详细的诊断信息和测试结果。

## 🔧 统计功能不工作的排查

### 1. 检查配置

运行诊断工具：

```bash
python3 diagnose_stats.py
```

确保以下配置正确：

- ✅ `OWNER_ID` 已设置（必需）
- ✅ `TOKEN` 和 `CHANNEL_ID` 已设置
- ✅ Bot 已添加到频道

### 2. Bot 权限要求

Bot **必须是频道管理员**才能获取统计信息。

#### 如何添加 Bot 为管理员：

1. 打开频道设置
2. 进入 "管理员" (Administrators)
3. 点击 "添加管理员" (Add Administrator)
4. 搜索并添加您的 Bot
5. **至少给予以下权限**：
   - ✅ 发送消息 (Post Messages)
   - ✅ 编辑消息 (Edit Messages) - 可选
   - ✅ 删除消息 (Delete Messages) - 可选

### 3. 统计数据来源

Bot 通过以下方式获取统计：

```python
# 转发消息到所有者私聊
forwarded = await bot.forward_message(
    chat_id=OWNER_ID,          # 需要配置
    from_chat_id=CHANNEL_ID,   
    message_id=message_id
)

# 从转发的消息获取统计
views = forwarded.views        # 浏览量
forwards = forwarded.forwards  # 转发量
```

**注意**：
- 需要配置 `OWNER_ID`
- Bot 必须能够向所有者发送消息
- 转发后会立即删除，不会留下痕迹

## ❓ 频道删除帖子后，Bot 还会索引吗？

### 之前的问题

在修复之前，如果您在频道中手动删除了帖子：
- ❌ 搜索索引**不会**自动更新
- ❌ 被删除的帖子仍会出现在搜索结果中
- ⚠️ 点击链接会显示 "消息不存在"

### 修复后的行为

现在通过 Bot 删除帖子时：

1. **从频道删除消息** - 包括主消息和所有关联消息
2. **从搜索索引删除** - 清理所有相关索引
3. **从数据库删除** - 清理数据库记录

### 删除帖子的正确方法

#### ✅ 推荐：通过 Bot 删除

```
1. 使用搜索功能找到要删除的帖子
2. 点击 "🗑️ 删除" 按钮
3. 确认删除
```

这样会自动清理所有相关数据。

#### ⚠️ 手动删除（在频道中）

如果您在频道中手动删除了帖子：

**方法 1：重建索引**（推荐）

```bash
python3 rebuild_search_index.py
```

这会从数据库重新构建索引，自动清理不存在的消息。

**方法 2：清理数据库**

```sql
-- 连接到数据库
sqlite3 data/submissions.db

-- 查找可能已删除的帖子（浏览量长期为0的）
SELECT id, message_id, title FROM published_posts 
WHERE views = 0 AND julianday('now') - julianday(publish_time) > 7;

-- 如果确认是已删除的帖子，手动删除记录
DELETE FROM published_posts WHERE id = <帖子ID>;
```

**方法 3：让 Bot 自动检测**（未来功能）

我们计划添加自动检测功能：
- 统计更新时检查消息是否存在
- 自动清理已删除的帖子记录

## 📊 统计算法说明

### 为什么不直接累加多条消息的统计？

当一个投稿包含多组媒体（超过10个文件）时，会分成多条消息：
- 主帖（第1条）
- 回复帖（第2-N条）

**问题**：如果直接累加所有消息的浏览量：

```
主帖: 100 浏览
回复1: 80 浏览
回复2: 70 浏览
直接累加 = 250 浏览 ❌ (重复计数)
```

实际上可能只有 100 个用户查看了主帖，其中 80 个点开了回复1。

### 智能算法

```
有效浏览 = 主帖浏览 × 70% + 平均回复浏览 × 30% × 回复数
有效转发 = max(所有消息的转发数)  # 用户通常只转发主帖
有效反应 = 主帖反应 × 50% + 回复反应总和 × 50%

热度分数 = (有效浏览 × 0.3 + 有效转发 × 10 × 0.4 + 有效反应 × 5 × 0.3) × 时间衰减
```

详细说明请查看：`docs/archive/ALGORITHM_REFERENCE.md`

## 🚀 性能优化建议

### 统计更新频率

默认：每小时更新一次（只更新最近30天的帖子）

如果您的频道流量很大，可以调整：

```python
# 在 main.py 的 setup_application 函数中
job_queue.run_repeating(
    update_post_stats, 
    interval=3600,  # 改为 7200 = 每2小时
    first=60
)
```

### 减少 API 请求

统计更新时的 API 请求：
- 每个帖子：1-5 次请求（取决于有几组消息）
- 请求间隔：2 秒（避免触发限制）

**注意**：Telegram API 限制：
- 每秒最多 30 次请求
- 每分钟最多 20 次请求（对同一个聊天）

Bot 会自动控制请求速率。

## 📝 常见错误消息

### "未设置OWNER_ID，无法获取帖子统计"

**原因**：配置文件中未设置 `OWNER_ID`

**解决**：
1. 向 @userinfobot 发送任意消息获取您的 User ID
2. 在 `config.ini` 中设置：
   ```ini
   OWNER_ID = 您的数字ID
   ```
3. 重启 Bot

### "获取帖子统计失败"

**可能原因**：
1. Bot 不是频道管理员
2. 消息已被删除
3. 网络问题

**解决**：运行 `python3 diagnose_stats.py` 查看详细原因

### "统计数据更新完成：成功 0 个，失败 X 个"

**原因**：所有帖子的统计获取都失败了

**检查**：
1. Bot 是否是频道管理员
2. OWNER_ID 是否正确
3. 网络是否正常

## 🔍 进一步帮助

如果问题仍未解决：

1. **查看日志**：
   ```bash
   tail -f logs/bot.log
   ```

2. **运行诊断**：
   ```bash
   python3 diagnose_stats.py
   ```

3. **查看文档**：
   - [部署指南](DEPLOYMENT.md) - 部署配置和故障排查
   - [管理员指南](ADMIN_GUIDE.md) - 管理功能详解
   - [内存占用说明](MEMORY_USAGE.md) - 性能优化

4. **提交 Issue**：
   如果是 Bug，请在 GitHub 提交 Issue，附上：
   - 诊断工具的输出
   - 相关日志
   - Bot 配置（隐藏敏感信息）

---

## 相关文档

- [README](README.md) - 项目介绍和快速开始
- [部署指南](DEPLOYMENT.md) - 部署步骤和故障排查
- [管理员指南](ADMIN_GUIDE.md) - 管理功能和系统维护
- [脚本指南](SCRIPTS_GUIDE.md) - 所有管理脚本说明
- [索引管理器](INDEX_MANAGER_README.md) - 搜索索引管理
- [内存占用说明](MEMORY_USAGE.md) - 内存使用分析

