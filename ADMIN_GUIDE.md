# TeleSubmit v2 管理员指南

## 目录
1. [配置机器人所有者](#配置机器人所有者)
2. [管理员命令列表](#管理员命令列表)
3. [管理面板功能](#管理面板功能)
4. [黑名单管理](#黑名单管理)
5. [统计数据查看](#统计数据查看)
6. [内容管理](#内容管理)
7. [系统维护](#系统维护)
8. [常见问题](#常见问题)

---

## 配置机器人所有者

### 1. 获取您的 Telegram User ID

有三种方法获取您的 User ID：

**方法一：使用 @userinfobot**
1. 在 Telegram 中搜索 `@userinfobot`
2. 发送任意消息
3. 机器人会回复您的 User ID

**方法二：使用 @getmyid_bot**
1. 在 Telegram 中搜索 `@getmyid_bot`
2. 点击 START
3. 查看 "Your user ID" 字段

**方法三：使用机器人的 `/debug` 命令**
1. 启动您的机器人
2. 发送 `/debug` 命令
3. 查看 "您的用户ID" 字段

### 2. 配置 OWNER_ID

编辑 `config.ini` 文件：

```ini
[BOT]
# 机器人所有者的 Telegram User ID
OWNER_ID = 你的用户ID数字
```

或者使用环境变量（适用于 Docker 部署）：

```bash
export OWNER_ID=你的用户ID数字
```

**示例**：
```ini
OWNER_ID = 5073758941
```

### 3. 验证配置

重启机器人后，发送 `/debug` 命令检查：

```
🔍 调试信息

👤 您的用户ID: 5073758941
🤖 机器人所有者ID: 5073758941
✅ 您是所有者: True
```

---

## 管理员命令列表

### 基础命令

| 命令 | 说明 | 示例 |
|------|------|------|
| `/start` | 启动机器人（管理员可看到管理面板） | `/start` |
| `/help` | 查看帮助信息 | `/help` |
| `/debug` | 查看系统调试信息 | `/debug` |

### 黑名单管理命令

| 命令 | 说明 | 示例 |
|------|------|------|
| `/blacklist_add <user_id> [原因]` | 添加用户到黑名单 | `/blacklist_add 123456789 发送垃圾内容` |
| `/blacklist_remove <user_id>` | 从黑名单移除用户 | `/blacklist_remove 123456789` |
| `/blacklist_list` | 查看黑名单列表 | `/blacklist_list` |

### 统计命令

| 命令 | 说明 | 示例 |
|------|------|------|
| `/hot` | 查看热门投稿 | `/hot` |
| `/mystats` | 查看个人统计 | `/mystats` |

### 搜索命令

| 命令 | 说明 | 示例 |
|------|------|------|
| `/search <关键词>` | 全文搜索 | `/search Python` |
| `/search #标签` | 标签搜索 | `/search #编程` |
| `/tags [数量]` | 查看标签云 | `/tags 10` |
| `/myposts` | 查看我的投稿 | `/myposts` |
| `/searchuser <user_id>` | 搜索指定用户的投稿 | `/searchuser 123456789` |

### 系统命令

| 命令 | 说明 | 示例 |
|------|------|------|
| `/settings` | 查看机器人设置 | `/settings` |
| `/cancel` | 取消当前操作 | `/cancel` |

---

## 管理面板功能

### 访问管理面板

发送 `/start` 命令后，管理员会看到特殊的管理员菜单：

```
📝 开始投稿  |  📊 我的统计
📋 我的投稿  |  🔥 热门内容
🔍 搜索      |  🏷️ 标签云
👑 管理面板  |  📈 全局统计
❓ 帮助      |  ℹ️ 关于
```

### 管理面板选项

点击 **👑 管理面板** 按钮，会显示以下选项：

1. **📊 全局统计**
   - 查看频道总投稿数
   - 查看用户活跃度
   - 查看热门标签
   - 查看浏览量、转发量等数据

2. **👥 用户管理**
   - 查看用户列表
   - 查看用户投稿统计
   - 管理用户权限（开发中）

3. **🚫 黑名单管理**
   - 快速添加/移除黑名单
   - 查看黑名单原因
   - 批量管理（开发中）

4. **🏷️ 标签管理**
   - 查看所有标签
   - 查看标签使用统计
   - 标签合并（开发中）

5. **🔄 更新统计**
   - 手动更新帖子统计数据
   - 刷新浏览量、转发量、热度分数

6. **📤 数据导出**
   - 导出投稿数据（开发中）
   - 导出用户数据（开发中）

---

## 黑名单管理

### 添加用户到黑名单

**方法一：使用命令**
```
/blacklist_add 123456789 发送垃圾内容
```

**方法二：通过管理面板**
1. 点击 **👑 管理面板**
2. 点击 **🚫 黑名单**
3. 输入用户 ID 和原因

### 查看黑名单

```
/blacklist_list
```

输出示例：
```
📋 黑名单用户列表:

1. ID: 123456789
   原因: 发送垃圾内容
   添加时间: 2025-10-25 10:30:00

2. ID: 987654321
   原因: 恶意刷屏
   添加时间: 2025-10-23 15:45:00
```

### 移除黑名单

```
/blacklist_remove 123456789
```

### 黑名单效果

被加入黑名单的用户：
- ❌ 无法使用机器人的任何功能
- ❌ 无法发送投稿
- ❌ 无法使用搜索功能
- ❌ 发送消息会收到"您已被列入黑名单"提示

---

## 统计数据查看

### 全局统计

通过管理面板访问 **📈 全局统计**，可以看到：

```
📊 频道统计数据

📝 总投稿数: 1,234
👥 活跃用户: 567
🏷️ 标签数量: 89

📈 浏览数据
👀 总浏览: 45,678
📤 总转发: 1,234
❤️ 总反应: 890

🔥 TOP 10 热门帖子
1. 【标题】Python学习资源汇总
   热度: 985.6 | 👀 1,234 | 📤 56

...
```

### 个人统计

```
/mystats
```

查看您自己的投稿统计数据。

### 热门内容

```
/hot
```

查看全站热门投稿，支持筛选：
- 📅 按时间：今天/本周/本月
- 🔢 数量：前10/前20/前30

---

## 内容管理

### 查看投稿详情

1. 使用 `/search` 命令搜索投稿
2. 点击 **📊 查看统计** 查看详细数据
3. 管理员可以看到额外的操作按钮

### 删除投稿（管理员专属）

1. 搜索到目标投稿
2. 点击 **🗑️ 删除** 按钮
3. 确认删除操作

**注意**：删除投稿会同时删除：
- 数据库中的记录
- 搜索索引中的数据

频道中的消息不会被自动删除，请在频道中手动删除对应消息。

### 编辑投稿（开发中）

未来将支持编辑投稿的标题、标签等信息。

---

## 系统维护

### 查看系统状态

使用 `/debug` 命令查看：

```
🔍 调试信息

👤 您的用户ID: 5073758941
🤖 机器人所有者ID: 5073758941
✅ 您是所有者: True

📺 频道ID: @xgdTest
🔄 机器人模式: DOCUMENT
👁️ 显示投稿人: False
📲 通知所有者: True
⏱️ 会话超时: 300秒

🗄️ 黑名单用户数: 2
📂 用户会话数: 5
🕒 服务器时间: 2025-10-25 10:30:00

💻 系统信息
🖥️ 操作系统: Darwin 25.0.0
🐍 Python版本: 3.11.5
💾 内存使用: 45.2% (2.3GB/5.1GB)
💿 磁盘使用: 60.5% (120GB/198GB)
⚡ CPU使用率: 12.3%
```

### 更新统计数据

统计数据会自动每小时更新一次，也可以手动触发：

1. 进入管理面板
2. 点击 **🔄 更新统计**

这会更新所有投稿的：
- 浏览量
- 转发量
- 反应数
- 热度分数

### 重建搜索索引

如果搜索功能异常，可以重建索引：

```bash
# 删除旧索引
rm -rf data/search_index/*

# 重建索引
python3 migrate_to_search.py
```

### 数据库备份

建议定期备份数据库：

```bash
# 备份主数据库
cp data/submissions.db data/backups/submissions_$(date +%Y%m%d).db

# 备份黑名单数据库
cp data/blacklist.db data/backups/blacklist_$(date +%Y%m%d).db

# 备份搜索索引
mkdir -p backups
tar -czf backups/search_index_$(date +%Y%m%d).tar.gz data/search_index/
```

### 查看日志

```bash
# 查看最新日志
tail -f logs/bot_$(date +%Y%m%d).log

# 查看错误日志
grep ERROR logs/bot_*.log

# 查看特定用户的操作
grep "user_id: 123456789" logs/bot_*.log
```

---

## 常见问题

### Q1: 如何知道有新投稿？

**A**: 配置 `NOTIFY_OWNER = true`，每次有新投稿时会收到通知：

```
📬 新投稿通知

👤 投稿人: @username (ID: 123456789)
📝 标题: Python学习资源
🏷️ 标签: #Python #编程
📅 时间: 2025-10-25 10:30:00

🔗 查看投稿: https://t.me/channel/123
```

### Q2: 如何隐藏/显示投稿人信息？

**A**: 修改 `config.ini` 中的 `SHOW_SUBMITTER` 设置：

```ini
# 显示投稿人信息
SHOW_SUBMITTER = true

# 隐藏投稿人信息（默认）
SHOW_SUBMITTER = false
```

### Q3: 如何修改机器人模式？

**A**: 修改 `config.ini` 中的 `BOT_MODE` 设置：

```ini
# 仅支持媒体投稿（图片、视频等）
BOT_MODE = MEDIA

# 仅支持文档投稿（PDF、Word等）
BOT_MODE = DOCUMENT

# 混合模式（支持所有类型）
BOT_MODE = MIXED
```

### Q4: 如何限制标签数量？

**A**: 修改 `config.ini` 中的 `ALLOWED_TAGS` 设置：

```ini
# 每个投稿最多允许的标签数量
ALLOWED_TAGS = 30
```

### Q5: 用户投稿后多久会超时？

**A**: 修改 `config.ini` 中的 `TIMEOUT` 设置：

```ini
# 会话超时时间（秒）
TIMEOUT = 300  # 5分钟
```

### Q6: 如何查看某个用户的所有投稿？

**A**: 使用 `/searchuser` 命令：

```
/searchuser 123456789
```

### Q7: 黑名单用户能看到频道内容吗？

**A**: 能。黑名单只限制用户使用机器人的功能，不影响用户查看频道内容。

### Q8: 如何批量删除投稿？

**A**: 目前不支持批量删除，需要逐个删除。您可以：
1. 使用 `/search` 搜索要删除的内容
2. 逐个点击删除按钮

或者直接在 Telegram 频道中批量删除消息。

### Q9: 统计数据不准确怎么办？

**A**: 
1. 进入管理面板
2. 点击 **🔄 更新统计**
3. 等待更新完成

或者等待自动更新（每小时执行一次）。

### Q10: 如何添加其他管理员？

**A**: 目前只支持单一所有者。如需多管理员功能，可以：
1. 修改源代码添加管理员列表
2. 或为其他管理员提供频道管理权限

---

## 高级功能

### 自定义热度算法

热度分数计算公式在 `handlers/stats_handlers.py` 中：

```python
def calculate_heat_score(views, forwards, reactions, publish_time):
    """
    计算帖子热度分数
    
    公式:
    heat_score = (views * 1.0 + forwards * 5.0 + reactions * 3.0) * time_factor
    """
    # ... 详见源代码
```

您可以调整权重来改变热度计算方式。

### 自定义命令菜单

在 `main.py` 的 `setup_bot_commands` 函数中修改：

```python
commands = [
    BotCommand("start", "🚀 启动机器人"),
    BotCommand("submit", "📝 发起投稿"),
    # ... 添加您的自定义命令
]
```

### 定时任务配置

在 `main.py` 的 `setup_application` 函数中可以添加定时任务：

```python
# 添加自定义定时任务
job_queue.run_repeating(
    your_custom_function,
    interval=3600,  # 每小时执行
    first=60        # 启动后60秒首次执行
)
```

---

## 安全建议

1. **保护 Token**
   - 不要将 `config.ini` 提交到公开仓库
   - 使用 `.gitignore` 忽略配置文件
   - 定期更换 Bot Token

2. **保护 OWNER_ID**
   - 不要公开您的 User ID
   - 使用环境变量存储敏感信息

3. **定期备份**
   - 每天备份数据库
   - 备份搜索索引
   - 保存配置文件

4. **监控日志**
   - 定期查看错误日志
   - 关注异常行为
   - 及时处理黑名单

5. **更新维护**
   - 定期更新依赖包
   - 关注安全漏洞
   - 测试新功能

---

## 技术支持

如遇到问题：

1. 查看日志文件 `logs/`
2. 运行 `/debug` 命令检查状态
3. 查看 `README.md` 文档
4. 运行测试脚本 `test_tag_cloud.py`
5. 提交 Issue 到项目仓库

---

## 相关文档

- [README](README.md) - 项目介绍和快速开始
- [脚本指南](SCRIPTS_GUIDE.md) - 所有管理脚本详细说明
- [部署指南](DEPLOYMENT.md) - 部署步骤和故障排查
- [索引管理器](INDEX_MANAGER_README.md) - 搜索索引管理
- [内存占用说明](MEMORY_USAGE.md) - 内存使用分析
- [更新日志](CHANGELOG.md) - 版本历史

## 相关文件

- `config.ini` - 主配置文件
- `config.ini.example` - 配置示例
- `main.py` - 主程序
- `handlers/` - 命令处理器
- `utils/blacklist.py` - 黑名单管理
- `handlers/stats_handlers.py` - 统计功能
- `handlers/search_handlers.py` - 搜索功能

---

**最后更新**: 2025-10-25
**版本**: v2.0

