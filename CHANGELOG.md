# 更新日志

所有重要的项目更改都会记录在此文件中。

格式基于 [Keep a Changelog](https://keepachangelog.com/zh-CN/1.0.0/)，
本项目遵循 [语义化版本](https://semver.org/lang/zh-CN/)。

---

## [2.1.0] - 2025-10-24

### 🎉 新增功能

- **搜索引擎**: 集成 Whoosh 全文搜索引擎，支持中文分词（基于 jieba）
  - 按关键词搜索投稿内容
  - 按标签快速查找
  - 搜索结果按相关度和热度排序
- **数据迁移工具**: 提供 `migrate_to_search.py` 将现有投稿导入搜索索引

### 🔧 改进

- **部署脚本增强**:
  - `deploy.sh` 支持 `--rebuild` 和 `--clean` 选项
  - `start.sh` 增加更详细的启动检查和功能状态展示
  - 优化 Makefile，新增 `migrate`、`check`、`dev` 等命令
- **Docker 优化**:
  - 容器名称更新为 `telesubmit-v2`
  - 增加 g++ 编译器支持（用于 Whoosh 编译）
  - 优化健康检查逻辑（检查主进程而非仅配置文件）
  - 内存限制提升至 1GB（搜索功能需要）
  - 新增 `data/search_index` 目录挂载
- **构建优化**:
  - 更新 `.dockerignore`，排除更多不必要文件
  - 更新 `.gitignore`，忽略搜索索引文件

### 📦 依赖更新

- 新增 `whoosh >= 2.7.4` - 全文搜索引擎
- 新增 `jieba >= 0.42.1` - 中文分词库

### 📝 文档

- 新增搜索功能相关文档（SEARCH_INTEGRATION.md 等）
- 更新部署脚本的帮助信息

---

## [2.0.0] - 2024-10-24

### 🎉 重大更新

这是一个完全重写的版本，采用了更现代化的架构和更好的代码组织。

### ✨ 新增功能

- **模块化架构**: 将代码拆分为多个模块（handlers, utils, config），更易维护
- **环境变量支持**: 支持通过环境变量配置，方便容器化部署
- **改进的会话管理**: 使用数据库存储用户会话，支持并发处理
- **黑名单系统**: 完整的黑名单管理功能，支持添加/移除/查询
- **搜索功能**: 支持按关键词、标签、投稿人搜索历史投稿
- **统计功能**: 详细的投稿统计信息和用户排行
- **批量操作**: 支持一次投稿多个文件/图片
- **更好的错误处理**: 更友好的错误提示和异常处理
- **日志系统**: 完整的日志记录，方便调试和监控

### 🔧 改进

- **性能优化**: 使用异步操作，提升响应速度
- **代码质量**: 更好的代码组织和文档注释
- **配置管理**: 统一的配置管理，支持默认值和验证
- **用户体验**: 更清晰的提示信息和交互流程
- **安全性**: 添加权限检查和输入验证

### 🏗️ 架构变化

```
v1.x (单文件)          →  v2.x (模块化)
main.py (379行)        →  main.py (主入口)
                          ├── config/
                          │   └── settings.py (配置管理)
                          ├── handlers/
                          │   ├── basic_handlers.py (基础命令)
                          │   ├── submission_handlers.py (投稿处理)
                          │   ├── admin_handlers.py (管理功能)
                          │   └── search_handlers.py (搜索功能)
                          └── utils/
                              ├── database.py (数据库操作)
                              ├── helpers.py (辅助函数)
                              └── blacklist.py (黑名单管理)
```

### 📦 依赖更新

- `python-telegram-bot`: 升级到 21.10
- 新增 `python-dotenv`: 支持 .env 文件
- 新增 `aiosqlite`: 异步数据库操作
- 新增 `psutil`: 系统监控

### 🔄 迁移指南

从 v1.x 迁移到 v2.0：

1. **配置文件**: 
   - 旧版配置可以继续使用
   - 建议使用新的 `config.ini.example` 作为模板

2. **数据库**:
   - 旧的 `submissions.db` 可以继续使用
   - 会自动创建新的 `user_sessions.db` 用于会话管理

3. **命令变化**:
   - 所有命令保持向后兼容
   - 新增了搜索和统计命令

### ⚠️ 破坏性变化

- 配置文件读取逻辑改变，现在支持环境变量优先
- 某些内部 API 已重构，如果你基于 v1.x 做了自定义修改，需要适配新架构

### 🐛 Bug 修复

- 修复了长时间运行后的内存泄漏问题
- 修复了并发投稿时的状态冲突
- 修复了特殊字符处理的问题
- 改进了文件上传的稳定性

### 📝 文档

- 新增快速开始指南 (QUICKSTART.md)
- 更新了 README 文档
- 添加了详细的代码注释

---

## [1.0.0] - 初始版本

- 基础投稿功能
- 简单的管理命令
- 单文件实现

