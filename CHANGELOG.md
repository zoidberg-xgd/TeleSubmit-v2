# 更新日志

所有重要的项目更改都会记录在此文件中。

格式基于 [Keep a Changelog](https://keepachangelog.com/zh-CN/1.0.0/)，
本项目遵循 [语义化版本](https://semver.org/lang/zh-CN/)。

---

### 修复

- **索引管理器修复**:
  - 修复数据库列名错误：`id` → `message_id`
  - 修复缺失的导入：添加 `os` 和 `shutil`
  - 统一返回值类型：所有操作返回 `dict` 格式
  - 简化索引优化逻辑避免 API 兼容性问题

- **修复数据库列名错误**:
  - `published_posts` 表的主键是 `message_id`，没有 `id` 列
  - 删除相关说明中误用 `id` 的示例，统一为 `message_id`

### 之前新增

- **帖子删除功能（OWNER 专用）**:
  - 搜索结果中添加删除按钮（仅 OWNER 可见）
  - `/myposts` 命令中添加删除按钮（OWNER 专用）
  - 批量删除命令 `/delete_posts` 支持：
    - 单个删除：`/delete_posts 123`
    - 多个删除：`/delete_posts 123 456 789`
    - 范围删除：`/delete_posts 100-110`
    - 混合删除：`/delete_posts 100-110 150 200-205`
    - 最多一次删除 50 个帖子
  - 完善的权限检查机制（仅 OWNER_ID 用户可删除）
  - 删除操作包括：
    - 从数据库删除帖子记录
    - 从搜索索引删除
    - 删除关联的多媒体消息索引
  - 不删除频道中的实际消息（需手动删除）
  - 删除后标签统计自动更新
  - 删除后搜索索引实时更新
  - 详细的删除统计报告

- **文件名搜索支持**:
  - 搜索引擎新增 `filename` 字段，支持文件名搜索
  - 文档上传时自动提取并保存文件名
  - 多字段搜索：标题、简介、标签、**文件名**
  - 完全兼容旧数据（历史投稿无文件名）

### 改进

- 数据库 schema 更新：
  - `published_posts` 表新增 `filename` 字段
  - 文档存储格式升级：`document:file_id:filename`
  - 完全向后兼容旧格式

- 搜索引擎优化：
  - Whoosh Schema 包含 filename 字段
  - 支持中文分词的文件名搜索
  - 查询解析器扩展至 4 个字段
  - 修复搜索结果中文件名显示问题

### 新增工具

- `migrate_add_filename.py` - 数据库 schema 迁移工具
- `migrate_extract_filenames.py` - 文件名提取迁移说明
- `FILENAME_SEARCH_UPGRADE.md` - 详细升级指南
- `test_delete_feature.py` - 删除功能测试脚本
- `DELETE_POST_GUIDE.md` - 帖子删除功能详细指南

### 安全改进

- 更新 `.gitignore`，增强临时文件保护：
  - 自动忽略所有 `test_*.py`、`fix_*.py`、`fetch_*.py` 等临时脚本
  - 自动忽略 `*_FIX.md`、`*_SUMMARY.md` 等临时文档
  - 保护敏感数据和测试文件不被误提交

### 文档

- 搜索帮助文档更新，说明文件名搜索功能
- 添加文件名搜索使用示例
- 更新 README，明确说明搜索范围包含文件名
 - 移除 README 中对 `docs/INDEX.md` 的失效链接

---

## [2.2.0] - 2025-10-25

### 新增

- **一键安装脚本** (`install.sh`):
  - 自动检测系统环境（Linux/macOS）
  - 智能检查并安装依赖（Docker/Python）
  - 交互式选择部署方式（Docker/Systemd/直接运行）
  - 集成配置向导，引导完成初始配置
  - 支持多种 Linux 发行版（Ubuntu/Debian/CentOS/RHEL）

- **更新脚本** (`update.sh`):
  - 自动备份数据和配置
  - 检测当前部署方式并智能更新
  - 显示更新内容预览
  - 支持暂存和恢复本地更改
  - 自动重启服务

- **重启脚本** (`restart.sh`):
  - 智能查找并停止所有运行中的机器人进程
  - 优雅停止（SIGTERM）+ 强制终止（SIGKILL，超时10秒）
  - 配置文件验证（可选，与 `check_config.py` 集成）
  - 支持 `--stop` 参数仅停止不重启
  - 兼容 macOS 和 Linux 系统
  - 自动处理多个进程实例

- **卸载脚本** (`uninstall.sh`):
  - 优雅停止所有服务
  - 可选择保留或删除数据
  - 自动备份数据（如果选择删除）
  - 清理 Systemd/Docker 相关配置

### 文档

- **README.md 全面优化**:
  - 全新的视觉设计，使用表格和图标
  - 添加项目亮点展示区域
  - 更清晰的快速开始指南
  - 优化命令列表展示
  - 增加详细的使用示例
  - 使用 Shields.io 徽章
  - 更清晰的项目结构展示

- **新增 DEPLOYMENT.md**:
  - 📋 详细的部署指南
  - 🔧 四种部署方式完整说明
  - ⚙️ 配置说明和示例
  - 🔄 更新和维护指南
  - 🔍 故障排查手册
  - 🛡️ 安全建议

### 改进

- **部署脚本增强**:
  - 所有脚本添加彩色输出（红/绿/黄/蓝）
  - 统一的错误处理和用户反馈
  - 更详细的进度提示
  - 支持非交互式运行（Docker 环境）
  - 添加执行权限检查

- **Makefile 扩展**:
  - 新增 `check` 命令（检查配置）
  - 新增 `update` 命令（更新到最新版本）
  - 优化 `backup` 命令（包含时间戳）
  - 改进 `status` 命令（显示资源使用）

### 新增文件

- `install.sh` - 一键安装脚本（支持多平台）
- `update.sh` - 智能更新脚本
- `uninstall.sh` - 优雅卸载脚本
- `DEPLOYMENT.md` - 完整部署文档

### 优化

- README 使用更专业的排版和布局
- 添加更多视觉元素（图标、徽章、表格）
- 统一文档风格和格式
- 改进代码示例的可读性
- 优化移动端阅读体验

### 文档清理

- **精简 README.md**（从 918 行减少到 ~500 行）：
  - 移除与 DEPLOYMENT.md 重复的部署细节
  - 移除详细的故障排查内容（指向部署指南）
  - 移除冗长的配置示例（保留最小配置）
  - 移除重复的 Docker、更新、安全建议章节
  - 精简使用示例和依赖列表
  - 保持核心功能展示和命令参考

- **删除重复/过时文档**：
  - `DEPLOY_GUIDE.md`（与 DEPLOYMENT.md 重复）
  - `PROJECT_READY.md`（临时项目状态文件）
  - `PRIVACY_PROTECTION_SUMMARY.md`（临时总结文件）
  - `GITHUB_FILES.md`、`GITHUB_UPLOAD_GUIDE.md`、`PUSH_TO_GITHUB.md`（开发临时文件）
  - `隐私保护完成.md`（中文临时文件）

- **文档结构优化**：
  - README：项目介绍、快速开始、核心功能、命令参考
  - DEPLOYMENT.md：详细部署、配置、更新、故障排查
  - ADMIN_GUIDE.md：管理功能详解
  - CHANGELOG.md：版本历史记录

---

## [2.1.0] - 2025-10-25

### 新增

- **搜索引擎**: 集成 Whoosh 全文搜索引擎，支持中文分词（基于 jieba）
  - 按关键词搜索投稿内容
  - 按标签快速查找
  - 搜索结果按相关度和热度排序
- **数据迁移工具**: 提供 `migrate_to_search.py` 将现有投稿导入搜索索引

### 改进

- **部署脚本增强**:
  - `deploy.sh` 支持 `--rebuild` 和 `--clean` 选项
  - `start.sh` 增加更详细的启动检查和功能状态展示
  - 优化 Makefile，新增 `migrate`、`check`、`dev` 等命令
- **Docker 优化**:
  - 容器名称更新为 `telesubmit-v2`
  - 增加 g++ 编译器支持（用于 Whoosh 编译）
  - 优化健康检查逻辑（检查主进程而非仅配置文件）
  - 内存限制提升至 1GB（搜索功能需要）
  - 新增 `data/search_index` 目录挂载
- **构建优化**:
  - 更新 `.dockerignore`，排除更多不必要文件
  - 更新 `.gitignore`，忽略搜索索引文件

### 依赖更新

- 新增 `whoosh >= 2.7.4` - 全文搜索引擎
- 新增 `jieba >= 0.42.1` - 中文分词库

### 文档

- 新增搜索功能相关文档（SEARCH_INTEGRATION.md 等）
- 更新部署脚本的帮助信息

---

## [2.0.0] - 2025-10-25

### 重大更新

这是一个完全重写的版本，采用了更现代化的架构和更好的代码组织。

### 新增

- **模块化架构**: 将代码拆分为多个模块（handlers, utils, config），更易维护
- **环境变量支持**: 支持通过环境变量配置，方便容器化部署
- **改进的会话管理**: 使用数据库存储用户会话，支持并发处理
- **黑名单系统**: 完整的黑名单管理功能，支持添加/移除/查询
- **搜索功能**: 支持按关键词、标签、投稿人搜索历史投稿
- **统计功能**: 详细的投稿统计信息和用户排行
- **批量操作**: 支持一次投稿多个文件/图片
- **更好的错误处理**: 更友好的错误提示和异常处理
- **日志系统**: 完整的日志记录，方便调试和监控

### 改进

- **性能优化**: 使用异步操作，提升响应速度
- **代码质量**: 更好的代码组织和文档注释
- **配置管理**: 统一的配置管理，支持默认值和验证
- **用户体验**: 更清晰的提示信息和交互流程
- **安全性**: 添加权限检查和输入验证

### 架构变化

```
v1.x (单文件)          →  v2.x (模块化)
main.py (379行)        →  main.py (主入口)
                          ├── config/
                          │   └── settings.py (配置管理)
                          ├── handlers/
                          │   ├── basic_handlers.py (基础命令)
                          │   ├── submission_handlers.py (投稿处理)
                          │   ├── admin_handlers.py (管理功能)
                          │   └── search_handlers.py (搜索功能)
                          └── utils/
                              ├── database.py (数据库操作)
                              ├── helpers.py (辅助函数)
                              └── blacklist.py (黑名单管理)
```

### 依赖更新

- `python-telegram-bot`: 升级到 21.10
- 新增 `python-dotenv`: 支持 .env 文件
- 新增 `aiosqlite`: 异步数据库操作
- 新增 `psutil`: 系统监控

### 迁移指南

从 v1.x 迁移到 v2.0：

1. **配置文件**: 
   - 旧版配置可以继续使用
   - 建议使用新的 `config.ini.example` 作为模板

2. **数据库**:
   - 旧的 `submissions.db` 可以继续使用
   - 会自动创建新的 `user_sessions.db` 用于会话管理

3. **命令变化**:
   - 所有命令保持向后兼容
   - 新增了搜索和统计命令

### 破坏性变化

- 配置文件读取逻辑改变，现在支持环境变量优先
- 某些内部 API 已重构，如果你基于 v1.x 做了自定义修改，需要适配新架构

### 修复

- 修复了长时间运行后的内存泄漏问题
- 修复了并发投稿时的状态冲突
- 修复了特殊字符处理的问题
- 改进了文件上传的稳定性

### 文档

- 新增快速开始指南 (QUICKSTART.md)
- 更新了 README 文档
- 添加了详细的代码注释

---

## [1.0.0] - 初始版本

- 基础投稿功能
- 简单的管理命令
- 单文件实现

