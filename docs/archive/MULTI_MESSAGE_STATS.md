# 多组媒体热度统计功能说明（智能算法版）

## 问题背景

当用户提交超过10个媒体文件时，Telegram API 会将它们分成多组发送：
- 第1组：主帖（message_id=803）
- 第2-5组：回复到主帖（message_id=813, 823, 833, 843）

之前的热度统计只计算主帖的数据，导致统计不准确。

## 为什么不能直接累加？

### 问题1：重复计数
```
用户A: 看了主帖 → 看了回复1 → 看了回复2
直接累加: views = 3 ❌（实际只有1个用户）
```

### 问题2：权重差异
```
主帖：大部分用户都会看
回复帖：只有部分用户会点开
应该：主帖权重 > 回复帖权重
```

### 问题3：转发行为
```
用户通常只转发主帖，不会转发回复
直接累加转发数会虚高
```

## 智能算法设计

### 1. 浏览量（有效去重）
```python
# 假设：看主帖的用户中，40%会点开回复帖
有效浏览 = 主帖浏览 * 70% + 回复帖平均浏览 * 30% * 回复帖数量
```

**示例**：
```
主帖: 100浏览
回复1: 80浏览, 回复2: 70浏览, 回复3: 60浏览, 回复4: 50浏览
平均回复浏览: (80+70+60+50)/4 = 65

有效浏览 = 100*0.7 + 65*0.3*4 = 70 + 78 = 148
（而不是直接累加的 360）
```

### 2. 转发量（取最大值）
```python
# 用户只会转发主帖，不会转发回复
有效转发 = max(主帖转发, 回复1转发, 回复2转发, ...)
```

**示例**：
```
主帖: 5转发, 回复1: 3转发, 回复2: 2转发, 回复3: 2转发, 回复4: 1转发
有效转发 = 5（而不是直接累加的 13）
```

### 3. 反应数（加权累加）
```python
# 每条帖子的反应都是独立的
有效反应 = 主帖反应 * 50% + 所有回复反应总和 * 50%
```

**示例**：
```
主帖: 10反应
回复总和: 8+7+6+5 = 26反应

有效反应 = 10*0.5 + 26*0.5 = 5 + 13 = 18
（而不是直接累加的 36）
```

### 4. 热度分数
```python
base_score = (有效浏览 * 0.3) + (有效转发 * 10 * 0.4) + (有效反应 * 5 * 0.3)
time_decay = 2 ** (-age_days / 7)  # 7天半衰期
heat_score = base_score * time_decay
```

## 额外质量指标

### 互动率（Engagement Rate）
```python
互动率 = (总转发 + 总反应) / 总浏览
```
- 高互动率 → 内容质量好，用户愿意互动
- 典型值：5%-15%

### 完成率（Completion Rate）
```python
完成率 = 最后一组浏览量 / 第一组浏览量
```
- 高完成率 → 内容吸引力强，用户看完所有帖子
- 典型值：30%-60%

### 质量分数（Quality Score）
```python
质量分 = 互动率 * 60 + 完成率 * 40
```
- 综合评估内容质量
- 0-100分

## 实际对比

### 场景：5组媒体帖子
```
主帖 803: 浏览 100 | 转发 5 | 反应 10
消息 813: 浏览  80 | 转发 3 | 反应  8
消息 823: 浏览  70 | 转发 2 | 反应  7
消息 833: 浏览  60 | 转发 2 | 反应  6
消息 843: 浏览  50 | 转发 1 | 反应  5
```

### ❌ 直接累加（旧方案）
```
总浏览: 360
总转发: 13
总反应: 36
热度分: (360*0.3 + 13*10*0.4 + 36*5*0.3) * time_decay
       = (108 + 52 + 54) * time_decay
       = 214 * time_decay
```

### ✅ 智能算法（新方案）
```
有效浏览: 100*0.7 + 65*0.3*4 = 148
有效转发: max(5,3,2,2,1) = 5
有效反应: 10*0.5 + 26*0.5 = 18
热度分: (148*0.3 + 5*10*0.4 + 18*5*0.3) * time_decay
       = (44.4 + 20 + 27) * time_decay
       = 91.4 * time_decay

质量指标:
  互动率: (13+36)/360 = 13.6%
  完成率: 50/100 = 50%
  质量分: 13.6*60 + 50*40 = 28.16
```

**差异分析**：
- 直接累加虚高了 134% (214 vs 91.4)
- 智能算法更接近真实热度
- 同时提供质量指标辅助判断

## 技术实现

### 文件结构
```
utils/heat_calculator.py          # 新增：智能算法模块
  ├── calculate_multi_message_heat()    # 主算法
  ├── calculate_engagement_rate()       # 互动率
  ├── calculate_completion_rate()       # 完成率
  └── get_quality_metrics()             # 质量指标

handlers/stats_handlers.py        # 修改：使用新算法
  └── update_post_stats()               # 调用智能算法

database/db_manager.py            # 修改：添加字段
  └── related_message_ids TEXT         # 存储关联消息ID

handlers/publish.py               # 修改：记录关联ID
  ├── handle_media_publish()            # 返回所有消息
  └── save_published_post()             # 保存关联ID
```

### 日志输出示例
```
INFO: 帖子 803 有 4 个关联消息，使用智能算法计算热度
INFO: 帖子 803 热度计算完成 | 有效浏览: 148 | 有效转发: 5 | 
      有效反应: 18 | 热度: 91.4 | 互动率: 13.6% | 完成率: 50%
```

## 迁移说明

### 首次安装
直接启动即可，数据库会自动创建包含新字段的表。

### 已有数据库升级
```bash
python3 migrate_multi_message_stats.py
```

### 验证
```bash
sqlite3 submissions.db "PRAGMA table_info(published_posts);"
# 应该看到 related_message_ids 字段
```

## 性能考虑

1. **API 调用频率**
   - 每个帖子需要 1 + N 次API调用（N为关联消息数）
   - 每组消息之间延迟1秒，避免触发限制

2. **更新周期**
   - 默认每小时更新一次
   - 只更新最近30天的帖子

3. **向后兼容**
   - 单消息帖子自动使用简化逻辑
   - `related_message_ids` 为 NULL 时只统计主帖

## 算法参数调优

可以在 `utils/heat_calculator.py` 中调整参数：

```python
# 浏览量权重
main_views * 0.7 + avg_related_views * 0.3  # 可调整 0.7/0.3

# 反应权重
main_reactions * 0.5 + total_related_reactions * 0.5  # 可调整 0.5/0.5

# 质量分权重
engagement_rate * 60 + completion_rate * 40  # 可调整 60/40
```

根据实际运行数据，可以微调这些参数以获得最佳效果。

