# 删除功能测试清单

## ✅ 自动化测试（已完成）

- [x] 数据库结构检查
- [x] 标签统计逻辑验证
- [x] 权限配置检查
- [x] 搜索索引检查
- [x] 代码 lint 检查

### 测试结果

```
✅ 数据库结构正常
✅ 标签统计从 published_posts 表实时查询（删除后自动更新）
✅ OWNER_ID 已配置
✅ 搜索引擎已初始化
✅ 无 lint 错误
```

## 📋 手动测试清单

### 1. 搜索结果中的删除按钮

#### 测试步骤（OWNER 用户）：
- [ ] 使用 `/search 关键词` 搜索帖子
- [ ] 验证每个搜索结果下方有 **🗑️ 删除** 按钮
- [ ] 点击删除按钮
- [ ] 验证出现确认对话框
- [ ] 点击"确认"按钮
- [ ] 验证显示删除成功消息
- [ ] 再次搜索，验证该帖子不再出现

#### 测试步骤（非 OWNER 用户）：
- [ ] 使用非 OWNER 账号搜索
- [ ] 验证搜索结果**没有**删除按钮
- [ ] 验证只有"查看原帖"按钮

### 2. /myposts 命令的删除按钮

#### 测试步骤（OWNER 用户）：
- [ ] 使用 `/myposts` 查看投稿列表
- [ ] 验证显示"💡 提示：作为管理员，您可以直接删除帖子"
- [ ] 验证每个帖子下方有删除按钮
- [ ] 点击删除按钮
- [ ] 确认删除
- [ ] 验证删除成功
- [ ] 再次使用 `/myposts`，验证帖子已消失

#### 测试步骤（非 OWNER 用户）：
- [ ] 使用非 OWNER 账号执行 `/myposts`
- [ ] 验证**没有**管理员提示
- [ ] 验证**没有**删除按钮

### 3. 批量删除命令 /delete_posts

#### 测试 3.1：单个删除
```bash
/delete_posts 123
```
- [ ] 执行命令
- [ ] 验证显示删除统计
- [ ] 验证成功删除 1 个帖子

#### 测试 3.2：多个删除
```bash
/delete_posts 123 456 789
```
- [ ] 执行命令
- [ ] 验证显示删除统计
- [ ] 验证成功删除 3 个帖子

#### 测试 3.3：范围删除
```bash
/delete_posts 100-110
```
- [ ] 执行命令
- [ ] 验证显示删除统计
- [ ] 验证删除范围内的所有帖子

#### 测试 3.4：混合删除
```bash
/delete_posts 100-110 150 200-205
```
- [ ] 执行命令
- [ ] 验证显示详细统计（成功/失败/未找到）

#### 测试 3.5：错误处理
```bash
/delete_posts 999999
```
- [ ] 执行命令
- [ ] 验证显示"未找到"消息

#### 测试 3.6：权限检查
- [ ] 使用非 OWNER 账号执行 `/delete_posts 123`
- [ ] 验证显示"权限不足"消息

#### 测试 3.7：参数验证
```bash
/delete_posts
```
- [ ] 验证显示使用说明

### 4. 标签统计更新验证

#### 测试步骤：
- [ ] 使用 `/tags` 查看当前标签统计
- [ ] 记录某个标签的计数（例如：#测试: 5 次）
- [ ] 删除一个包含该标签的帖子
- [ ] 再次使用 `/tags` 查看标签统计
- [ ] 验证该标签的计数减少了 1（例如：#测试: 4 次）

### 5. 搜索索引更新验证

#### 测试步骤：
- [ ] 使用 `/search 特定关键词` 搜索
- [ ] 记录搜索结果数量
- [ ] 删除其中一个搜索结果
- [ ] 再次搜索相同关键词
- [ ] 验证搜索结果数量减少
- [ ] 验证被删除的帖子不再出现

### 6. 频道消息验证

#### 测试步骤：
- [ ] 删除一个帖子后
- [ ] 访问删除结果中提供的频道链接
- [ ] 验证频道消息**仍然存在**
- [ ] 手动在频道中删除该消息（可选）

### 7. 日志验证

#### 测试步骤：
- [ ] 执行删除操作后
- [ ] 检查 `logs/bot.log` 文件
- [ ] 验证包含删除日志：
  ```
  INFO: 批量删除：已删除帖子 message_id=123
  INFO: 已从搜索索引删除帖子: 123
  INFO: 已从数据库删除帖子记录: ID=45, message_id=123
  ```

## 📊 测试报告模板

### 测试环境
- 操作系统: [填写]
- Python 版本: [填写]
- 机器人版本: [填写]
- 测试时间: [填写]

### 测试结果总结

| 测试项 | 结果 | 备注 |
|--------|------|------|
| 搜索结果删除按钮（OWNER） | ☐ 通过 ☐ 失败 | |
| 搜索结果删除按钮（非OWNER） | ☐ 通过 ☐ 失败 | |
| /myposts 删除按钮（OWNER） | ☐ 通过 ☐ 失败 | |
| /myposts 删除按钮（非OWNER） | ☐ 通过 ☐ 失败 | |
| 批量删除 - 单个 | ☐ 通过 ☐ 失败 | |
| 批量删除 - 多个 | ☐ 通过 ☐ 失败 | |
| 批量删除 - 范围 | ☐ 通过 ☐ 失败 | |
| 批量删除 - 混合 | ☐ 通过 ☐ 失败 | |
| 权限检查 | ☐ 通过 ☐ 失败 | |
| 标签统计更新 | ☐ 通过 ☐ 失败 | |
| 搜索索引更新 | ☐ 通过 ☐ 失败 | |
| 频道消息保留 | ☐ 通过 ☐ 失败 | |

### 发现的问题

1. [问题描述]
   - 重现步骤：
   - 预期行为：
   - 实际行为：
   - 严重程度：

## ⚠️ 测试注意事项

1. **备份数据**：测试前备份 `data/submissions.db`
2. **使用测试环境**：建议在测试环境中测试，避免影响生产数据
3. **权限配置**：确保 `config.ini` 中配置了正确的 `OWNER_ID`
4. **测试账号**：准备至少 2 个测试账号（1 个 OWNER，1 个普通用户）
5. **频道消息**：删除操作不会删除频道消息，测试后需手动清理
6. **测试数据**：建议创建几个测试帖子用于删除测试

## 🔧 故障排查

### 问题：删除按钮不显示
- 检查是否为 OWNER 用户
- 检查 `config.ini` 中的 `OWNER_ID` 配置
- 重启机器人重新加载配置

### 问题：删除失败
- 检查日志文件 `logs/bot.log`
- 验证 message_id 是否存在
- 检查数据库文件权限

### 问题：搜索索引未更新
- 检查搜索引擎是否已初始化
- 查看日志中的搜索索引删除记录
- 尝试重建搜索索引

## 📝 测试完成后

- [ ] 填写测试报告
- [ ] 记录发现的问题
- [ ] 清理测试数据
- [ ] 恢复备份（如需要）
- [ ] 更新文档（如有改进建议）

---

**测试脚本**: `test_delete_feature.py`  
**使用指南**: `DELETE_POST_GUIDE.md`  
**更新日志**: `CHANGELOG.md`

